---
title: Grokking Simplicity FP CH12 ~ CH13
sidebar_position: 3
tags: ["functional-programming", "ch12-ch13"]
---

# ã€Šç°¡ç´„çš„è»Ÿé«”é–‹ç™¼æ€ç¶­ï¼šç”¨ Functional Programming é‡æ§‹ç¨‹å¼ã€‹CH12 ~ CH13

## ç›®éŒ„

- [Ch12. åˆ©ç”¨å‡½æ•¸èµ°è¨ª](#ch12-åˆ©ç”¨å‡½æ•¸èµ°è¨ª)
  - [1. `map()`](#1-map)
  - [2. `filter()`](#2-filter)
  - [3. `reduce()`](#3-reduce)
  - [ç« ç¯€æå•](#ç« ç¯€æå•)
- [Ch13. ä¸²é€£å‡½æ•¸å¼å·¥å…·](#ch13-ä¸²é€£å‡½æ•¸å¼å·¥å…·)
  - [ç« ç¯€é‡é»](#ç« ç¯€é‡é»)
  - [éˆå¼æ“ä½œ](#éˆå¼æ“ä½œå°‡å¤šå€‹å‡½æ•¸ä¸²æ¥åœ¨ä¸€èµ·å½¢æˆä¸€å€‹æ–°çš„å‡½æ•¸)
  - [13.1 è¨ˆç®—é«˜æ¶ˆè²»åŠ›çš„æœ€é«˜æ¶ˆè²»é‡‘é¡](#131-è¨ˆç®—é«˜æ¶ˆè²»åŠ›çš„æœ€é«˜æ¶ˆè²»é‡‘é¡)
  - [13.5 æ‰¾å‡ºåªæ¶ˆè²»éä¸€æ¬¡çš„é¡§å®¢](#135-æ‰¾å‡ºåªæ¶ˆè²»éä¸€æ¬¡çš„é¡§å®¢ä»¥é™£åˆ—å›å‚³é¡§å®¢çš„-email)
  - [æµèåˆ(stream fusion)](#æµèåˆstream-fusion)
  - [13.6 ç•¶ for loop é›£ä»¥é‡æ§‹æ™‚](#136-ç•¶-for-loop-é›£ä»¥é‡æ§‹æ™‚)
  - [å„ç¨®ç·´ç¿’é¡Œå€‘](#å„ç¨®ç·´ç¿’é¡Œå€‘)
  - [ç« ç¯€æå•](#ç« ç¯€æå•-1)

## Ch12. åˆ©ç”¨å‡½æ•¸èµ°è¨ª

Code Smell: æœ‰ç›¸ä¼¼çš„å‡½å¼å¯¦ä½œ

- éš±æ€§ -> é¡¯æ€§å‡½æ•¸
- å›å‘¼å‡½å¼

> map()ã€filter()ã€reduce() æ˜¯ä¸‰å€‹å¸¸è¦‹çš„é«˜éšå‡½æ•¸ï¼Œè®“ FP çš„é‚è¼¯çœ‹èµ·ä¾†æ›´ç°¡æ½”ã€‚

| ç‰¹æ€§       | for è¿´åœˆ               | forEach()                    | map()                              |
| ---------- | ---------------------- | ---------------------------- | ---------------------------------- |
| èªæ³•       | for (let i = 0; ...)   | array.forEach(...)           | array.map(...)                     |
| å›å‚³å€¼     | ç„¡                     | ç„¡ (undefined)               | æ–°é™£åˆ—                             |
| å¯å¦ä¸­æ–·   | æ˜¯ (break, continue)   | å¦                           | å¦                                 |
| ä¿®æ”¹åŸé™£åˆ— | å¯æ‰‹å‹•æ§åˆ¶             | é€šå¸¸ç”¨æ–¼ä¿®æ”¹ï¼Œä½†ä¸å›å‚³æ–°é™£åˆ— | ä¸æœƒä¿®æ”¹ï¼ˆå‰µå»ºæ–°é™£åˆ—ï¼‰             |
| é©ç”¨å°è±¡   | ä»»ä½•å¯è¿­ä»£ç‰©ä»¶         | é™£åˆ—                         | é™£åˆ—                               |
| ä¸»è¦ç”¨é€”   | é«˜åº¦æ§åˆ¶ï¼Œè™•ç†é€šç”¨è¿­ä»£ | å°æ¯å€‹å…ƒç´ åŸ·è¡Œå‰¯ä½œç”¨         | å°‡æ¯å€‹å…ƒç´ è½‰æ›ç‚ºæ–°å½¢å¼ï¼Œç”Ÿæˆæ–°é™£åˆ— |

### 1. `map()`

> ä½¿ç”¨æƒ…å¢ƒï¼šå°‡é™£åˆ—ä¸­çš„æ¯å€‹å…ƒç´ è½‰æ›ç‚ºæ–°å½¢å¼ï¼Œç”Ÿæˆæ–°é™£åˆ—ã€‚

> è˜‹æœ ğŸ -> åŒ…è£æ©Ÿ ğŸ“¦ -> è²¼æ¨™çš„è˜‹æœ ğŸ ğŸ’°

```js
const arr = [1, 2, 3];
const newArr = arr.map((item) => {
  return item * 2;
});
console.log(newArr);
```

ï¼Š é™£åˆ—çš„å€¼å¯èƒ½ç‚º nullï¼Œä½¿ç”¨ `filter()`ã€ `?.` ä¾†é¿å…æ‹‹å‡ºéŒ¯èª¤ã€‚

<details>
<summary>ç·´ç¿’ 12-1ï¼šMega Mart å¯„é€è³€å¡</summary>

- customers é™£åˆ—åŒ…æ¶µæ‰€æœ‰ customer ç‰©ä»¶
- ä½¿ç”¨ map() ç”¢ç”Ÿè³€å¡ï¼ŒåŒ…æ¶µ `cursomer.firstName`, `cursomer.lastName`, `cursomer.address`

```js
const customers = [
  {
    firstName: "John",
    lastName: "Doe",
    address: "123 Main St",
    habbit: "reading",
  },
  {
    firstName: "Jane",
    lastName: "Smith",
    address: "456 Main St",
    habbit: "reading",
  },
  {
    firstName: "Jim",
    lastName: "Beam",
    address: "789 Main St",
    habbit: "reading",
  },
];

const cards = "YOUR ANSWER HERE";
```

</details>

### 2. `filter()`

> ä½¿ç”¨æƒ…å¢ƒï¼šéæ¿¾é™£åˆ—ä¸­çš„å…ƒç´ ï¼Œç”Ÿæˆæ–°é™£åˆ—ã€‚

> ä¸€ç±ƒè˜‹æœ ğŸ ğŸ -> ç¯©é¸ ğŸ” -> å¥½è˜‹æœ ğŸ

- æ¥­å‹™æƒ…å¢ƒï¼š Mega Mart æƒ³è¦èˆ‡é«˜æ¶ˆè²»åŠ›çš„é¡§å®¢å»ºç«‹é—œä¿‚ï¼Œå› æ­¤éœ€è¦éæ¿¾å‡ºé«˜æ¶ˆè²»åŠ›çš„é¡§å®¢ã€‚
- ç¸½é¡§å®¢ 10 äºº -> é«˜æ¶ˆè²» 4 äºº / ä½æ¶ˆè²» 6 äºº

```js
function selectBestCustomers(customers) {
  return customers.filter((customer) => {
    return customer.total > 1000;
  });
}
```

#### å¦‚ä½•æ•´ç†éæ–¼è¤‡é›œå¾—ç¯©é¸é‚è¼¯ï¼šå›å‘¼å‡½å¼ï¼

> æ¥­å‹™é‚è¼¯ï¼šã€Œæœ€è¿‘ä¸€å¹´å…§æœ‰äº¤æ˜“ã€ç¸½é‡‘é¡è¶…é $1000ã€ä¸” email æœ‰é©—è­‰ã€VIP ç­‰ç´šç‚º gold æˆ– platinum çš„é¡§å®¢ã€

```javascript
function isHighSpender(customer) {
  return customer.total > 1000;
}

function isRecentBuyer(customer) {
  const oneYearAgo = new Date();
  oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
  return new Date(customer.lastPurchaseDate) > oneYearAgo;
}

function hasVerifiedEmail(customer) {
  return customer.emailVerified === true;
}

function isVipCustomer(customer) {
  return ["gold", "platinum"].includes(customer.vipLevel);
}

function selectBestCustomers(customers) {
  return customers.filter((customer) => {
    return (
      isHighSpender(customer) &&
      isRecentBuyer(customer) &&
      hasVerifiedEmail(customer) &&
      isVipCustomer(customer)
    );
  });
}
```

<details>
<summary>ç·´ç¿’ 12-2ï¼šMega Mart å¯„æ¸¬è©¦ä¿¡ä»¶çµ¦é¡§å®¢æ¸…å–®ä¸­çš„ 1/3 ä½¿ç”¨è€…</summary>

- æ¸¬è©¦åå–® testGroupï¼šé¡§å®¢ id å¯ä»¥æ•´é™¤ 3 çš„é¡§å®¢
- éæ¸¬è©¦åå–®ï¼šå…¶é¤˜é¡§å®¢

```js
const customers = [
  { id: 1, name: "John" },
  { id: 2, name: "Jane" },
  { id: 3, name: "Jim" },
  { id: 4, name: "Jill" },
  { id: 5, name: "Jack" },
];
const testGroup = customers.filter("YOUR ANSWER HERE");

const nonTestGroup = customers.filter("YOUR ANSWER HERE");
```

</details>

## 3. `reduce()`

> ä½¿ç”¨æƒ…å¢ƒï¼šå°‡é™£åˆ—ä¸­çš„å…ƒç´ ç´¯ç©ç‚ºä¸€å€‹å€¼ã€‚

> ä¸€å †æ°´æœ ğŸ ğŸ -> è®Šæˆæœæ± ğŸ¹

```js
function sum(numbers) {
  return reduce(numbers, 0, function (total, number) {
    return total + number;
  });
}
/


// å°‡æ‰€æœ‰æ•¸å­—ç›¸ä¹˜
function product(numbers) {
  return reduce(numbers, 1, function (total, number) {
    return total * number;
  });
}
```

### `reduce()` çš„å¸¸è¦‹ç”¨é€”ï¼š

| åŠŸèƒ½             | æ¦‚å¿µèªªæ˜                                 | æ‡‰ç”¨å ´æ™¯                       | æ ¸å¿ƒç‰¹é»           | å¯¦éš›ä¾‹å­                  |
| ---------------- | ---------------------------------------- | ------------------------------ | ------------------ | ------------------------- |
| **å¾©åŸ (Undo)**  | é€éç´¯ç©æ­·å²ç‹€æ…‹ï¼Œå¯ä»¥å›åˆ°ä¹‹å‰çš„ä»»ä½•ç‹€æ…‹ | æ–‡å­—ç·¨è¼¯å™¨ã€ç¹ªåœ–è»Ÿé«”ã€éŠæˆ²å­˜æª” | ç‹€æ…‹å †ç–Šã€æ­·å²è¨˜éŒ„ | Word çš„ Ctrl+Z åŠŸèƒ½       |
| **é‡è¤‡ (Redo)**  | åœ¨å¾©åŸå¾Œï¼Œå¯ä»¥é‡æ–°åŸ·è¡Œè¢«å¾©åŸçš„æ“ä½œ       | èˆ‡å¾©åŸé…åˆä½¿ç”¨çš„å‰é€²åŠŸèƒ½       | é›™å‘ç‹€æ…‹ç®¡ç†       | Word çš„ Ctrl+Y åŠŸèƒ½       |
| **æ™‚é–“ç§»å‹•é™¤éŒ¯** | è¨˜éŒ„æ¯ä¸€æ­¥çš„åŸ·è¡Œéç¨‹ï¼Œå¯ä»¥è·³åˆ°ä»»æ„æ™‚é–“é» | ç¨‹å¼é™¤éŒ¯ã€ç‹€æ…‹åˆ†æã€æ•ˆèƒ½ç›£æ§   | æ™‚é–“è»¸è¨˜éŒ„ã€å¿«ç…§   | Redux DevTools çš„æ™‚é–“æ—…è¡Œ |
| **å¯©è¨ˆè»Œè·¡**     | å®Œæ•´è¨˜éŒ„æ‰€æœ‰æ“ä½œçš„è©³ç´°è³‡è¨Š               | ç³»çµ±å®‰å…¨ã€åˆè¦æª¢æŸ¥ã€æ“ä½œè¿½è¹¤   | ä¸å¯è®Šè¨˜éŒ„ã€å®Œæ•´æ€§ | éŠ€è¡Œäº¤æ˜“è¨˜éŒ„ã€ç³»çµ±æ—¥èªŒ    |

<details>
<summary>æŒ‰ç·¨ï¼šé€™é‚Šç®—æ˜¯è‡ªå·±æ‰¾çš„ä¾‹å­ï¼Œä¸åœ¨è®€æ›¸æœƒåŠæ›¸ä¸­æåŠã€‚</summary>

```js
// ==========================================
// 1. å¾©åŸ (Undo) - ç´”å‡½æ•¸å¼æ–‡å­—ç·¨è¼¯å™¨
// ==========================================

// ç´”å‡½æ•¸ï¼šåŸ·è¡Œå–®ä¸€ç·¨è¼¯æ“ä½œ
const applyEdit = (content, edit) => {
  switch (edit.type) {
    case "INSERT":
      return (
        content.slice(0, edit.position) +
        edit.text +
        content.slice(edit.position)
      );
    case "DELETE":
      return (
        content.slice(0, edit.position) +
        content.slice(edit.position + edit.length)
      );
    case "REPLACE":
      return (
        content.slice(0, edit.position) +
        edit.newText +
        content.slice(edit.position + edit.oldText.length)
      );
    default:
      return content;
  }
};

// ç´”å‡½æ•¸ï¼šå»ºç«‹ç·¨è¼¯æ­·å²ç‹€æ…‹
const createEditHistory = (edits, initialContent = "") => {
  return edits.reduce(
    (history, edit) => {
      const previousContent = history[history.length - 1];
      const newContent = applyEdit(previousContent, edit);
      return [...history, newContent];
    },
    [initialContent]
  );
};

// ç´”å‡½æ•¸ï¼šå¾©åŸæ“ä½œ
const undo = (history, currentIndex) => ({
  content: history[Math.max(0, currentIndex - 1)],
  newIndex: Math.max(0, currentIndex - 1),
});

// ç´”å‡½æ•¸ï¼šé‡è¤‡æ“ä½œ
const redo = (history, currentIndex) => ({
  content: history[Math.min(history.length - 1, currentIndex + 1)],
  newIndex: Math.min(history.length - 1, currentIndex + 1),
});

// ä½¿ç”¨ç¯„ä¾‹
const edits = [
  { type: "INSERT", position: 0, text: "Hello" },
  { type: "INSERT", position: 5, text: " World" },
  { type: "REPLACE", position: 6, oldText: "World", newText: "JavaScript" },
];

const history = createEditHistory(edits);
console.log("ç·¨è¼¯æ­·å²:", history);
// ['', 'Hello', 'Hello World', 'Hello JavaScript']

const undoResult = undo(history, 3);
console.log("å¾©åŸå¾Œ:", undoResult);
// { content: 'Hello World', newIndex: 2 }

// ==========================================
// 2. é‡è¤‡ (Redo) - ç´”å‡½æ•¸å¼ç‹€æ…‹ç®¡ç†
// ==========================================

// ç´”å‡½æ•¸ï¼šå»ºç«‹ç‹€æ…‹ç®¡ç†å™¨
const createStateManager = (actions, initialState = null) => {
  return actions.reduce(
    (stateHistory, action) => {
      const currentState = stateHistory.states[stateHistory.states.length - 1];
      const newState = action.reducer(currentState, action.payload);

      return {
        states: [...stateHistory.states, newState],
        actions: [...stateHistory.actions, action],
        currentIndex: stateHistory.states.length,
      };
    },
    {
      states: [initialState],
      actions: [],
      currentIndex: 0,
    }
  );
};

// ç´”å‡½æ•¸ï¼šåŸ·è¡Œå¾©åŸ/é‡è¤‡æ“ä½œ
const timeTravel = (stateManager, targetIndex) => ({
  ...stateManager,
  currentIndex: Math.max(
    0,
    Math.min(stateManager.states.length - 1, targetIndex)
  ),
  currentState:
    stateManager.states[
      Math.max(0, Math.min(stateManager.states.length - 1, targetIndex))
    ],
});

// ä½¿ç”¨ç¯„ä¾‹ - è³¼ç‰©è»Šç‹€æ…‹ç®¡ç†
const cartActions = [
  {
    type: "ADD_ITEM",
    payload: { id: 1, name: "iPhone", price: 999 },
    reducer: (state, item) => ({
      ...state,
      items: [...(state?.items || []), item],
      total: (state?.total || 0) + item.price,
    }),
  },
  {
    type: "ADD_ITEM",
    payload: { id: 2, name: "MacBook", price: 1999 },
    reducer: (state, item) => ({
      ...state,
      items: [...state.items, item],
      total: state.total + item.price,
    }),
  },
  {
    type: "REMOVE_ITEM",
    payload: { id: 1 },
    reducer: (state, payload) => {
      const newItems = state.items.filter((item) => item.id !== payload.id);
      const newTotal = newItems.reduce((sum, item) => sum + item.price, 0);
      return { ...state, items: newItems, total: newTotal };
    },
  },
];

const cartHistory = createStateManager(cartActions, { items: [], total: 0 });
console.log("è³¼ç‰©è»Šç‹€æ…‹æ­·å²:", cartHistory.states);

// å¾©åŸåˆ°ç¬¬1æ­¥
const undoToStep1 = timeTravel(cartHistory, 1);
console.log("å¾©åŸåˆ°ç¬¬1æ­¥:", undoToStep1.currentState);

// é‡è¤‡åˆ°ç¬¬2æ­¥
const redoToStep2 = timeTravel(cartHistory, 2);
console.log("é‡è¤‡åˆ°ç¬¬2æ­¥:", redoToStep2.currentState);

// ==========================================
// 3. æ™‚é–“ç§»å‹•é™¤éŒ¯ - ç´”å‡½æ•¸å¼åŸ·è¡Œè¿½è¹¤
// ==========================================

// ç´”å‡½æ•¸ï¼šå»ºç«‹é™¤éŒ¯å¿«ç…§
const createDebugSnapshot = (
  step,
  operation,
  input,
  output,
  metadata = {}
) => ({
  step,
  timestamp: new Date().toISOString(),
  operation,
  input,
  output,
  metadata,
  performance: {
    executionTime: metadata.executionTime || 0,
    memoryUsage: metadata.memoryUsage || 0,
  },
});

// ç´”å‡½æ•¸ï¼šåŸ·è¡Œå¯è¿½è¹¤çš„æ“ä½œåºåˆ—
const executeWithTimeTravel = (operations, initialData) => {
  return operations.reduce(
    (debugState, operation, index) => {
      const startTime = performance.now();
      const result = operation.fn(debugState.currentData, operation.params);
      const endTime = performance.now();

      const snapshot = createDebugSnapshot(
        index + 1,
        operation.name,
        debugState.currentData,
        result,
        {
          params: operation.params,
          executionTime: endTime - startTime,
        }
      );

      return {
        currentData: result,
        snapshots: [...debugState.snapshots, snapshot],
        totalExecutionTime:
          debugState.totalExecutionTime + (endTime - startTime),
      };
    },
    {
      currentData: initialData,
      snapshots: [],
      totalExecutionTime: 0,
    }
  );
};

// ç´”å‡½æ•¸ï¼šè·³è½‰åˆ°ç‰¹å®šæ™‚é–“é»
const jumpToSnapshot = (debugState, stepNumber) => {
  const targetSnapshot = debugState.snapshots.find(
    (s) => s.step === stepNumber
  );
  return targetSnapshot ? targetSnapshot.output : debugState.currentData;
};

// ä½¿ç”¨ç¯„ä¾‹ - æ•¸æ“šè™•ç†ç®¡é“
const dataOperations = [
  {
    name: "FILTER_ACTIVE_USERS",
    fn: (users) => users.filter((user) => user.active),
    params: { condition: "active === true" },
  },
  {
    name: "MAP_USER_SCORES",
    fn: (users) => users.map((user) => ({ ...user, score: user.points * 1.5 })),
    params: { multiplier: 1.5 },
  },
  {
    name: "SORT_BY_SCORE",
    fn: (users) => [...users].sort((a, b) => b.score - a.score),
    params: { order: "desc" },
  },
  {
    name: "TAKE_TOP_5",
    fn: (users) => users.slice(0, 5),
    params: { limit: 5 },
  },
];

const initialUsers = [
  { id: 1, name: "Alice", active: true, points: 100 },
  { id: 2, name: "Bob", active: false, points: 80 },
  { id: 3, name: "Charlie", active: true, points: 120 },
  { id: 4, name: "Diana", active: true, points: 90 },
  { id: 5, name: "Eve", active: true, points: 110 },
];

const debugResult = executeWithTimeTravel(dataOperations, initialUsers);
console.log("åŸ·è¡Œçµæœ:", debugResult.currentData);
console.log("åŸ·è¡Œå¿«ç…§:", debugResult.snapshots);

// è·³è½‰åˆ°ç¬¬2æ­¥æŸ¥çœ‹ç‹€æ…‹
const step2State = jumpToSnapshot(debugResult, 2);
console.log("ç¬¬2æ­¥ç‹€æ…‹:", step2State);

// ==========================================
// 4. å¯©è¨ˆè»Œè·¡ - ç´”å‡½æ•¸å¼æ“ä½œæ—¥èªŒ
// ==========================================

// ç´”å‡½æ•¸ï¼šå»ºç«‹å¯©è¨ˆè¨˜éŒ„
const createAuditEntry = (
  action,
  user,
  resource,
  oldValue,
  newValue,
  metadata = {}
) => ({
  id: crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36),
  timestamp: new Date().toISOString(),
  action,
  user: {
    id: user.id,
    name: user.name,
    role: user.role,
    ip: user.ip || "unknown",
  },
  resource: {
    type: resource.type,
    id: resource.id,
    name: resource.name,
  },
  changes: {
    before: oldValue,
    after: newValue,
  },
  metadata: {
    userAgent: metadata.userAgent || "unknown",
    sessionId: metadata.sessionId || "unknown",
    ...metadata,
  },
  hash: `${action}-${user.id}-${resource.id}-${Date.now()}`,
});

// ç´”å‡½æ•¸ï¼šè™•ç†æ¥­å‹™æ“ä½œä¸¦ç”Ÿæˆå¯©è¨ˆè»Œè·¡
const executeBusinessOperations = (operations, initialState) => {
  return operations.reduce(
    (auditState, operation) => {
      const oldValue = auditState.currentState[operation.resourceId];
      const newValue = operation.transformer(oldValue, operation.payload);

      const auditEntry = createAuditEntry(
        operation.action,
        operation.user,
        operation.resource,
        oldValue,
        newValue,
        operation.metadata
      );

      return {
        currentState: {
          ...auditState.currentState,
          [operation.resourceId]: newValue,
        },
        auditTrail: [...auditState.auditTrail, auditEntry],
      };
    },
    {
      currentState: initialState,
      auditTrail: [],
    }
  );
};

// ç´”å‡½æ•¸ï¼šæŸ¥è©¢å¯©è¨ˆè»Œè·¡
const queryAuditTrail = (auditTrail, filters = {}) => {
  return auditTrail.filter((entry) => {
    return Object.entries(filters).every(([key, value]) => {
      if (key === "user") return entry.user.id === value;
      if (key === "action") return entry.action === value;
      if (key === "resource") return entry.resource.type === value;
      if (key === "dateFrom")
        return new Date(entry.timestamp) >= new Date(value);
      if (key === "dateTo") return new Date(entry.timestamp) <= new Date(value);
      return true;
    });
  });
};

// ä½¿ç”¨ç¯„ä¾‹ - éŠ€è¡Œå¸³æˆ¶æ“ä½œå¯©è¨ˆ
const bankOperations = [
  {
    action: "DEPOSIT",
    user: {
      id: "user123",
      name: "John Doe",
      role: "customer",
      ip: "192.168.1.1",
    },
    resource: { type: "account", id: "acc001", name: "Checking Account" },
    resourceId: "acc001",
    payload: { amount: 1000 },
    transformer: (currentBalance, payload) =>
      (currentBalance || 0) + payload.amount,
    metadata: { branch: "downtown", teller: "jane_smith" },
  },
  {
    action: "WITHDRAW",
    user: {
      id: "user123",
      name: "John Doe",
      role: "customer",
      ip: "192.168.1.1",
    },
    resource: { type: "account", id: "acc001", name: "Checking Account" },
    resourceId: "acc001",
    payload: { amount: 200 },
    transformer: (currentBalance, payload) => currentBalance - payload.amount,
    metadata: { atm: "atm_007", card: "**** 1234" },
  },
  {
    action: "TRANSFER",
    user: {
      id: "user123",
      name: "John Doe",
      role: "customer",
      ip: "192.168.1.1",
    },
    resource: { type: "account", id: "acc001", name: "Checking Account" },
    resourceId: "acc001",
    payload: { amount: 300, toAccount: "acc002" },
    transformer: (currentBalance, payload) => currentBalance - payload.amount,
    metadata: { transferType: "internal", recipient: "acc002" },
  },
];

const bankAudit = executeBusinessOperations(bankOperations, { acc001: 0 });
console.log("å¸³æˆ¶æœ€çµ‚ç‹€æ…‹:", bankAudit.currentState);
console.log("å®Œæ•´å¯©è¨ˆè»Œè·¡:", bankAudit.auditTrail);

// æŸ¥è©¢ç‰¹å®šç”¨æˆ¶çš„æ“ä½œè¨˜éŒ„
const userOperations = queryAuditTrail(bankAudit.auditTrail, {
  user: "user123",
});
console.log("ç”¨æˆ¶ user123 çš„æ“ä½œè¨˜éŒ„:", userOperations);

// æŸ¥è©¢æ‰€æœ‰è½‰å¸³æ“ä½œ
const transferOperations = queryAuditTrail(bankAudit.auditTrail, {
  action: "TRANSFER",
});
console.log("æ‰€æœ‰è½‰å¸³æ“ä½œ:", transferOperations);

// ==========================================
// é¡å¤–ï¼šçµ„åˆå¼ä½¿ç”¨ç¯„ä¾‹
// ==========================================

// çµåˆå››ç¨®åŠŸèƒ½çš„å®Œæ•´ç‹€æ…‹ç®¡ç†å™¨
const createCompleteStateManager = (actions, initialState) => {
  return actions.reduce(
    (manager, action, index) => {
      const startTime = performance.now();
      const oldState = manager.states[manager.states.length - 1];
      const newState = action.reducer(oldState, action.payload);
      const endTime = performance.now();

      // å»ºç«‹å¿«ç…§ (æ™‚é–“ç§»å‹•é™¤éŒ¯)
      const snapshot = createDebugSnapshot(
        index + 1,
        action.type,
        oldState,
        newState,
        { executionTime: endTime - startTime }
      );

      // å»ºç«‹å¯©è¨ˆè¨˜éŒ„
      const auditEntry = createAuditEntry(
        action.type,
        action.user || { id: "system", name: "System" },
        action.resource || {
          type: "state",
          id: "app",
          name: "Application State",
        },
        oldState,
        newState
      );

      return {
        // ç‹€æ…‹æ­·å² (æ”¯æ´å¾©åŸ/é‡è¤‡)
        states: [...manager.states, newState],
        currentIndex: manager.states.length,

        // é™¤éŒ¯å¿«ç…§ (æ™‚é–“ç§»å‹•é™¤éŒ¯)
        snapshots: [...manager.snapshots, snapshot],

        // å¯©è¨ˆè»Œè·¡
        auditTrail: [...manager.auditTrail, auditEntry],

        // æ•ˆèƒ½çµ±è¨ˆ
        totalExecutionTime: manager.totalExecutionTime + (endTime - startTime),
      };
    },
    {
      states: [initialState],
      currentIndex: 0,
      snapshots: [],
      auditTrail: [],
      totalExecutionTime: 0,
    }
  );
};

// ä½¿ç”¨ç¯„ä¾‹
const appActions = [
  {
    type: "LOGIN",
    payload: { userId: "user123", sessionId: "sess_abc" },
    reducer: (state, payload) => ({
      ...state,
      user: payload,
      isLoggedIn: true,
    }),
    user: { id: "user123", name: "John Doe", role: "user" },
  },
  {
    type: "UPDATE_PROFILE",
    payload: { name: "John Smith", email: "john.smith@example.com" },
    reducer: (state, payload) => ({
      ...state,
      user: { ...state.user, ...payload },
    }),
    user: { id: "user123", name: "John Doe", role: "user" },
  },
];

const completeManager = createCompleteStateManager(appActions, {
  user: null,
  isLoggedIn: false,
});

console.log("å®Œæ•´ç‹€æ…‹ç®¡ç†å™¨:", {
  currentState: completeManager.states[completeManager.currentIndex],
  stateHistory: completeManager.states,
  debugSnapshots: completeManager.snapshots,
  auditTrail: completeManager.auditTrail,
  performance: { totalTime: completeManager.totalExecutionTime },
});
```

</details>

### ç« ç¯€æå•

1. è§£æ±º null çš„æ–¹æ³•?

- ä½¿ç”¨ä¸å…·æœ‰ null çš„å€¼
- ä½¿ç”¨ filter éæ¿¾æ‰ null

2. map() å’Œ filter() çš„å·®ç•°?

- map() æœƒå°‡æ¯å€‹å…ƒç´ è½‰æ›ç‚ºæ–°å½¢å¼ï¼Œç”Ÿæˆæ–°é™£åˆ—ã€‚
- filter() æœƒéæ¿¾æ‰ä¸ç¬¦åˆæ¢ä»¶çš„å…ƒç´ ï¼Œç”Ÿæˆæ–°é™£åˆ—ã€‚

---

## Ch13. ä¸²é€£å‡½æ•¸å¼å·¥å…·

### ç« ç¯€é‡é»

- å°‡å‡½æ•¸å¼å·¥å…· ä¸²èµ·ä¾† æˆç‚ºå¤šæ­¥é©Ÿçš„éˆå¼æ“ä½œ (chain) ä¾†è™•ç†è¤‡é›œçš„ä»»å‹™
- æ¯å€‹æ­¥é©Ÿæ˜¯ä¸€é …ç°¡å–®æ“ä½œï¼Œæ˜“è®€ã€æ˜“æ’°å¯«ã€‚
- ç‚ºäº†å¯«å‡½å¼éˆçš„ä¸‹ä¸€æ­¥ï¼Œæœ‰æ™‚éœ€å…ˆç”¢ç”Ÿæ–°è³‡æ–™æˆ–æ“´å¢æ—¢æœ‰çš„è³‡æ–™ã€‚
  - å°‡éš±æ€§è¨Šæ¯ï¼Œè¡¨ç¤ºæˆé¡¯æ€§è³‡æ–™ã€‚

### éˆå¼æ“ä½œï¼šå°‡å¤šå€‹å‡½æ•¸ä¸²æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€å€‹æ–°çš„å‡½æ•¸ã€‚

> ç•¶æ¥­å‹™æƒ…å¢ƒè®Šå¾—è¤‡é›œï¼Œéœ€è¦å°‡ map()ã€filter()ã€reduce() ä¸²æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€å€‹æ–°çš„å‡½æ•¸ã€‚

### 13.1 è¨ˆç®—é«˜æ¶ˆè²»åŠ›çš„æœ€é«˜æ¶ˆè²»é‡‘é¡

- ç¸½é¡§å®¢: 10 äºº -> é«˜æ¶ˆè²» 4 äºº / ä½æ¶ˆè²» 6 äºº
- éœ€è¦æ‰¾åˆ°é«˜æ¶ˆè²»åŠ›ï¼Œä¸”æ¶ˆè²»æ¬¡æ•¸ 3 æ¬¡ä»¥ä¸Šçš„é¡§å®¢ï¼Œä¸¦è¨ˆç®—å…¶æœ€é«˜æ¶ˆè²»é‡‘é¡

```js
function biggestPurchaseBestCustomers(customers) {
  var bestCustomers = filter(customers, function (customer) {
    return customer.purchases.length > 3;
  });

  var biggestPurchases = map(bestCustomers, function (customer) {
    return reduce(
      customer.purchases,
      { total: 0 },
      function (biggestSoFar, purchase) {
        if (biggestSoFar.total > purchase.total) {
          return biggestSoFar;
        } else {
          return purchase;
        }
      }
    );
  });

  return biggestPurchases;
}
```

#### å•é¡Œï¼šå·¢ç‹€çµæ§‹ä¸å¥½ç†è§£

1. å‘½åé«˜éšå‡½æ•¸

```js
function biggestPurchaseBestCustomers(customers) {
  var bestCustomers = selectBestCustomers(customers); // æ‹†æˆé«˜éšå‡½æ•¸
  var biggestPurchases = getBiggestPurchase(bestCustomers); // æ‹†æˆé«˜éšå‡½æ•¸
  return biggestPurchases;
}

function isBestCustomer(customer) {
  return customer.purchases.length > 3;
}

function findBiggestPurchase(biggestSoFar, purchase) {
  if (biggestSoFar.total > purchase.total) {
    return biggestSoFar;
  } else {
    return purchase;
  }
}

function getBiggestPurchase(customer) {
  return reduce(customer.purchases, { total: 0 }, findBiggestPurchase);
}
```

- ç¼ºé»ï¼šå¦‚æœç›´æ¥å‘½åæˆé«˜éšå‡½æ•¸ï¼Œç„¡æ³•é‡è¤‡ä½¿ç”¨ã€‚

2. ä¾ç…§æ­¥é©Ÿï¼Œå‘½åå›å‘¼å‡½æ•¸

```js
function biggestPurchaseBestCustomers(customers) {
  var bestCustomers = filter(customers, isBestCustomer);
  var biggestPurchases = map(bestCustomers, getBiggestPurchase);
  return biggestPurchases;
}

// å°‡è¤‡é›œçš„æ¥­å‹™é‚è¼¯æ‹†æˆå›å‘¼å‡½æ•¸ï¼Œä¾› filter()ã€map()ã€reduce() ä½¿ç”¨
function isBestCustomer(customer) {
  return customer.purchases.length > 3;
}

function findBiggestPurchase(biggestSoFar, purchase) {
  if (biggestSoFar.total > purchase.total) {
    return biggestSoFar;
  } else {
    return purchase;
  }
}

function getBiggestPurchase(customer) {
  return reduce(customer.purchases, { total: 0 }, findBiggestPurchase);
}
```

---

### 13.5 æ‰¾å‡ºåªæ¶ˆè²»éä¸€æ¬¡çš„é¡§å®¢ï¼Œä»¥é™£åˆ—å›å‚³é¡§å®¢çš„ email

1. å¯ä»¥ä½¿ç”¨å“ªäº› javascript é«˜éšå‡½æ•¸ï¼Ÿ

<details>
  <summary>é»æˆ‘çœ‹ç­”æ¡ˆ</summary>

ç­”æ¡ˆæ˜¯ï¼šä½ å¯ä»¥ç”¨ `map()`ã€`filter()`

</details>

2. å®Œæ•´ç¨‹å¼ç¢¼

<details>
  <summary>é»æˆ‘çœ‹ç­”æ¡ˆ</summary>

```js
function getFirstTimersEmails(customers) {
  var firstTimers = filter(customers, function (customer) {
    return customer.purchases.length === 1;
  });

  var firstTimersEmails = map(firstTimers, function (customer) {
    return customer.email;
  });

  return firstTimersEmails;
}
```

</details>

### æµèåˆ(stream fusion)

```js
var names = map(customers, getFullName);
var nameLengths = map(names, getLength);
```

æµèåˆï¼š

```js
var nameLengths = map(map(customers, getFullName), getLength);
```

### 13.6 ç•¶ for loop é›£ä»¥é‡æ§‹æ™‚

1. ç†è§£ä¸¦é‡å¯«

- å…ˆè®€æ‡‚ for loop çš„ç›®çš„
- å†ç”¨å‡½æ•¸å¼å·¥å…·é‡æ§‹

2. ä¾ç…§ç·šç´¢é€²è¡Œé‡æ§‹ã€ç´°åŒ–æ­¥é©Ÿ

- ç„¡æ³•è®€æ‡‚ for loop çš„é‚è¼¯
- æ ¹æ“š for loop å±•ç¤ºçš„ä½éšè¨Šæ¯
- è½‰æ›æˆå‡½å¼éˆ

---

> æƒ…å¢ƒå•é¡Œ: å·²ç¶“æœ‰ for loopï¼Œè¦å¦‚ä½•é‡æ§‹ï¼Ÿ

```js
var answer = [];

var window = 5;

for (var i = 0; i < numbers.length; i++) {
  var sum = 0;
  var count = 0;

  for (var w = 0; w < window; w++) {
    sum += numbers[i + w];
    count++;
  }

  answer.push(sum / count);
}
```

å¦‚ä½•é‡æ§‹ï¼Ÿ

<details>
  <summary>é»æˆ‘çœ‹æç¤º</summary>

- å¤–å±¤è¿´åœˆï¼šå¤–å±¤è¿´åœˆå°‡ array é™£åˆ—çš„æ¯å€‹å…ƒç´ å–å‡ºåšè™•ç†
  - ä½¿ç”¨ map()
- å…§å±¤è¿´åœˆï¼šå…§å±¤è¿´åœˆå°‡ array é™£åˆ—çš„æ¯å€‹å…ƒç´ ç´¯é€²æˆä¸€å€‹å€¼
  - ä½¿ç”¨ reduce()

</details>

---

#### é‡æ§‹å¾Œçš„ç¨‹å¼ç¢¼

```js
// å¯ä»¥é‡è¤‡ä½¿ç”¨çš„å‡½æ•¸
function range(start, end) {
  var ret = [];

  for (var i = start; i < end; i++) {
    ret.push(i);
  }

  return ret;
}

// åŸºæ–¼ functional programming çš„ç¨‹å¼ç¢¼
var window = 5;

var indices = range(0, numbers.length);
var subarrays = map(indices, function (i) {
  return range(i, i + window);
});

var answer = map(subarrays, average);
```

---

èµ°è¨ªä¸Ÿå¤±çš„è³¼ç‰©è»Š

```javascript
var itemAdded = ["shirt", "shoes", "pants","shirts"];

var shippingCart = reduce(itemAdded, {}, addOne);

function addOne(shippingCart, item) {
  if(!cart[item]){
   return additem...
  }
}
```

### å„ç¨®ç·´ç¿’é¡Œå€‘

#### 13.13 æƒ…å¢ƒ ï¼šé¡§å®¢è³¼ç‰©è»Šè³‡æ–™éºå¤±ï¼Œç¶²ç«™ä»¥é™£åˆ—å½¢å¼è¨˜éŒ„æ‰€æœ‰æ›¾å‡ºç¾éçš„å•†å“

```js
var itemAdded = ["shirt", "shoes", "pants", "shirts"];
```

> æƒ…å¢ƒå•é¡Œï¼šä½¿ç”¨è€…çš„è³‡æ–™ä¸Ÿå¤±ï¼Œæ˜¯å¦å¯ä»¥ç”¨ä¸Šè¿°çš„é™£åˆ—ï¼Œé‡å»ºè³¼ç‰©è»Šï¼Ÿ

<details>
  <summary>é»æˆ‘çœ‹ç­”æ¡ˆ</summary>

```js
var itemAdded = ["shirt", "shoes", "pants", "shirts"];

var shippingCart = reduce(itemAdded, {}, addOne);

function addOne(shippingCart, item) {
  if(!cart[item]){
   return additem...
  }
}
```

</details>

#### ç·´ç¿’ 13-16~19ï¼šæ£’çƒç·´ç¿’è³½ç³»åˆ—

> æƒ…å¢ƒå•é¡Œï¼šMega Mart æ¯å¹´éƒ½æœƒæ´¾å“¡åƒåŠ è·æ¥­æ£’çƒæ¯”è³½ï¼Œæ•™ç·´æœƒæ ¹æ“šå“¡å·¥åå–®ç”Ÿæˆå“¡å·¥å»ºè­°ä½ç½®æ¸…å–®ï¼Œä¸¦å°‡è©•ä¼°è³‡æ–™å­˜å…¥ evaluations é™£åˆ—ã€‚

```plaintext
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Megamart å“¡å·¥åå–® â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ recommendations â”‚
â”‚   (æ¨è–¦åå–®)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ evaluations é™£åˆ— â”‚
â”‚   (è©•ä¼°è³‡æ–™)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åƒè³½äººå“¡åå–®   â”‚â”€â”€â”€â”€â†’â”‚   å…ˆç™¼é¸æ‰‹åå–®    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†‘
                                  â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  æ•™ç·´çµ¦æ¯å€‹äººçš„   â”‚
                        â”‚      å»ºè­°       â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

```js
var evaluations = [
  {
    name: "John",
    position: "catcher",
    score: 2,
  },
  {
    name: "Jane",
    position: "pitcher",
    score: 3,
  },
  {
    name: "Jim",
    position: "pitcher",
    score: 1,
  },
];

var roaster = {
  pitcher: "Jane",
  catcher: "John",
};
```

1. å¦‚ä½•æ ¹æ“š evaluations é™£åˆ—ï¼Œç”Ÿæˆ roster ç‰©ä»¶ï¼Ÿ
2. å…¶ä»–å•é¡Œç•¥ï¼Œè«‹è¦‹æ›¸æœ¬ã€‚

### ç« ç¯€æå•

1. éº¼æ˜¯æµèåˆï¼Ÿ

- å°‡ mapã€filter ç­‰æ¶µå¼ä¸²æ¥å†ä¸€èµ·ï¼Œé¿å…éå¤šä¸­ç¹¼ç¨‹å¼
